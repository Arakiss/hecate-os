name: Build HecateOS ISO

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      use_docker:
        description: 'Use Docker-based build'
        type: boolean
        default: false

env:
  DEBIAN_FRONTEND: noninteractive

jobs:
  lint:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        scandir: '.'
        ignore_paths: >-
          chroot
          binary
          cache
          .build
        severity: error

  build:
    name: Build ISO
    runs-on: ubuntu-24.04
    needs: lint

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up build environment
      if: ${{ !inputs.use_docker }}
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          live-build \
          debootstrap \
          squashfs-tools \
          xorriso \
          isolinux \
          syslinux-utils \
          grub-pc-bin \
          grub-efi-amd64-bin \
          grub-efi-amd64-signed \
          shim-signed \
          mtools \
          dosfstools

    - name: Cache packages
      uses: actions/cache@v4
      with:
        path: cache/
        key: ${{ runner.os }}-packages-${{ hashFiles('config/package-lists/*.list.chroot') }}
        restore-keys: |
          ${{ runner.os }}-packages-

    - name: Build ISO (Native)
      if: ${{ !inputs.use_docker }}
      run: sudo ./build.sh build

    - name: Build ISO (Docker)
      if: ${{ inputs.use_docker }}
      run: |
        docker build -f Dockerfile.build -t hecate-builder .
        docker run --rm --privileged \
          -v $(pwd):/build \
          -v $(pwd)/iso:/build/iso \
          hecate-builder build

    - name: Generate checksums
      run: |
        cd iso/
        for iso in *.iso; do
          [ -f "$iso" ] || continue
          sha256sum "$iso" > "$iso.sha256"
          md5sum "$iso" > "$iso.md5"
        done

    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: hecate-os-${{ github.sha }}
        path: |
          iso/*.iso
          iso/*.sha256
          iso/*.md5
        retention-days: 14
        compression-level: 0

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download ISO artifact
      uses: actions/download-artifact@v4
      with:
        name: hecate-os-${{ github.sha }}
        path: iso/

    - name: Get version from tag
      id: version
      run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: HecateOS ${{ steps.version.outputs.version }}
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: true
        files: |
          iso/*.iso
          iso/*.sha256
          iso/*.md5
