#!/bin/bash
#
# HecateOS System Information
# Displays hardware profile and system configuration
#
# Usage:
#   hecate-info [--all] [--json]
#

set -e

# Colors
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
WHITE='\033[1;37m'
RESET='\033[0m'

HECATE_VERSION=$(cat /etc/hecate/version 2>/dev/null || echo "0.1.0")
PROFILE_FILE="/etc/hecate/hardware-profile.json"

# Parse arguments
SHOW_ALL=false
OUTPUT_JSON=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --all|-a)
            SHOW_ALL=true
            shift
            ;;
        --json)
            OUTPUT_JSON=true
            shift
            ;;
        --help|-h)
            echo "Usage: hecate-info [--all] [--json]"
            echo ""
            echo "Options:"
            echo "  --all, -a   Show detailed information"
            echo "  --json      Output as JSON"
            exit 0
            ;;
        *)
            shift
            ;;
    esac
done

# JSON output
if [ "$OUTPUT_JSON" = true ]; then
    if [ -f "$PROFILE_FILE" ]; then
        cat "$PROFILE_FILE"
    else
        echo '{"error": "No hardware profile found"}'
    fi
    exit 0
fi

# Header
echo -e "${PURPLE}╦ ╦┌─┐┌─┐┌─┐┌┬┐┌─┐╔═╗╔═╗${RESET}"
echo -e "${PURPLE}╠═╣├┤ │  ├─┤ │ ├┤ ║ ║╚═╗${RESET}"
echo -e "${PURPLE}╩ ╩└─┘└─┘┴ ┴ ┴ └─┘╚═╝╚═╝${RESET}"
echo ""

# Version
echo -e "${WHITE}HecateOS${RESET} v${HECATE_VERSION}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# CPU Info
echo -e "${CYAN}CPU${RESET}"
CPU_MODEL=$(lscpu 2>/dev/null | grep "Model name" | cut -d: -f2 | xargs || echo "Unknown")
CPU_CORES=$(nproc 2>/dev/null || echo "?")
echo "  Model:  $CPU_MODEL"
echo "  Cores:  $CPU_CORES"
echo ""

# Memory Info
echo -e "${CYAN}Memory${RESET}"
MEM_TOTAL=$(free -h 2>/dev/null | grep Mem | awk '{print $2}' || echo "Unknown")
MEM_USED=$(free -h 2>/dev/null | grep Mem | awk '{print $3}' || echo "Unknown")
echo "  Total:  $MEM_TOTAL"
echo "  Used:   $MEM_USED"
echo ""

# GPU Info
echo -e "${CYAN}GPU${RESET}"
if command -v nvidia-smi &>/dev/null; then
    GPU_MODEL=$(nvidia-smi --query-gpu=name --format=csv,noheader 2>/dev/null | head -1 || echo "Unknown")
    GPU_DRIVER=$(nvidia-smi --query-gpu=driver_version --format=csv,noheader 2>/dev/null | head -1 || echo "Unknown")
    GPU_VRAM=$(nvidia-smi --query-gpu=memory.total --format=csv,noheader 2>/dev/null | head -1 || echo "Unknown")
    echo "  Model:  $GPU_MODEL"
    echo "  Driver: $GPU_DRIVER"
    echo "  VRAM:   $GPU_VRAM"
elif lspci 2>/dev/null | grep -qi nvidia; then
    echo "  NVIDIA GPU detected (driver not loaded)"
elif lspci 2>/dev/null | grep -qi amd; then
    GPU_MODEL=$(lspci 2>/dev/null | grep -i vga | grep -i amd | cut -d: -f3 | xargs || echo "AMD GPU")
    echo "  Model:  $GPU_MODEL"
else
    echo "  No discrete GPU detected"
fi
echo ""

# Storage Info
echo -e "${CYAN}Storage${RESET}"
ROOT_DISK=$(df -h / 2>/dev/null | tail -1 | awk '{print $1}' || echo "Unknown")
ROOT_SIZE=$(df -h / 2>/dev/null | tail -1 | awk '{print $2}' || echo "Unknown")
ROOT_USED=$(df -h / 2>/dev/null | tail -1 | awk '{print $5}' || echo "Unknown")
echo "  Root:   $ROOT_DISK"
echo "  Size:   $ROOT_SIZE"
echo "  Used:   $ROOT_USED"
echo ""

# Hardware Profile
if [ -f "$PROFILE_FILE" ]; then
    echo -e "${CYAN}Hardware Profile${RESET}"
    PROFILE=$(jq -r '.system.profile // "standard"' "$PROFILE_FILE" 2>/dev/null || echo "standard")
    PROFILE_CLASS=$(jq -r '.system.class // "workstation"' "$PROFILE_FILE" 2>/dev/null || echo "workstation")
    echo "  Profile: ${PROFILE^^}"
    echo "  Class:   $PROFILE_CLASS"
    echo ""
fi

# Detailed info
if [ "$SHOW_ALL" = true ]; then
    echo -e "${CYAN}Kernel${RESET}"
    echo "  Version: $(uname -r)"
    echo "  Arch:    $(uname -m)"
    echo ""

    echo -e "${CYAN}Optimizations${RESET}"
    # Check key optimizations
    if grep -q "mitigations=off" /proc/cmdline 2>/dev/null; then
        echo -e "  Mitigations:     ${GREEN}Disabled${RESET} (performance mode)"
    else
        echo -e "  Mitigations:     ${YELLOW}Enabled${RESET} (security mode)"
    fi

    SWAPPINESS=$(cat /proc/sys/vm/swappiness 2>/dev/null || echo "?")
    echo "  Swappiness:      $SWAPPINESS"

    if [ -d /sys/block/zram0 ]; then
        ZRAM_SIZE=$(cat /sys/block/zram0/disksize 2>/dev/null | numfmt --to=iec 2>/dev/null || echo "?")
        echo -e "  ZRAM:            ${GREEN}Enabled${RESET} ($ZRAM_SIZE)"
    else
        echo "  ZRAM:            Disabled"
    fi

    # CPU Governor
    GOVERNOR=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor 2>/dev/null || echo "unknown")
    echo "  CPU Governor:    $GOVERNOR"
    echo ""

    echo -e "${CYAN}Services${RESET}"
    for svc in docker nvidia-persistenced tuned irqbalance; do
        if systemctl is-active --quiet "$svc" 2>/dev/null; then
            echo -e "  $svc: ${GREEN}running${RESET}"
        elif systemctl is-enabled --quiet "$svc" 2>/dev/null; then
            echo -e "  $svc: ${YELLOW}enabled${RESET}"
        fi
    done
    echo ""
fi

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Run 'hecate info --all' for detailed information"
