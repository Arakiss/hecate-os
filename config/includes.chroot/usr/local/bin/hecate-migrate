#!/bin/bash
#
# HecateOS Migration System
# Runs pending migrations to update system configuration
#
# Migrations are timestamped scripts in /usr/share/hecate/migrations/
# Applied migrations are tracked in /etc/hecate/migrations.applied
#
# Usage:
#   hecate-migrate [--dry-run] [--list]
#

set -e

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
RESET='\033[0m'

MIGRATIONS_DIR="${HECATE_MIGRATIONS_DIR:-/usr/share/hecate/migrations}"
APPLIED_FILE="/etc/hecate/migrations.applied"

# Parse arguments
DRY_RUN=false
LIST_ONLY=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --list)
            LIST_ONLY=true
            shift
            ;;
        --help|-h)
            echo "Usage: hecate-migrate [--dry-run] [--list]"
            echo ""
            echo "Options:"
            echo "  --dry-run   Show what would be done without applying"
            echo "  --list      List all migrations and their status"
            exit 0
            ;;
        *)
            shift
            ;;
    esac
done

# Ensure directories exist
mkdir -p "$(dirname "$APPLIED_FILE")"
touch "$APPLIED_FILE"

# List migrations
if [ "$LIST_ONLY" = true ]; then
    echo -e "${CYAN}HecateOS Migrations${RESET}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    if [ -d "$MIGRATIONS_DIR" ] && [ "$(ls -A "$MIGRATIONS_DIR" 2>/dev/null)" ]; then
        for migration in "$MIGRATIONS_DIR"/*.sh; do
            [ -f "$migration" ] || continue
            ts=$(basename "$migration" | cut -d_ -f1)
            name=$(basename "$migration" .sh | cut -d_ -f2-)

            if grep -q "^$ts$" "$APPLIED_FILE" 2>/dev/null; then
                echo -e "  ${GREEN}✓${RESET} $ts - $name"
            else
                echo -e "  ${YELLOW}○${RESET} $ts - $name"
            fi
        done
    else
        echo "  No migrations found"
    fi
    exit 0
fi

# Run migrations
echo -e "${CYAN}Running migrations...${RESET}"

if [ ! -d "$MIGRATIONS_DIR" ]; then
    echo "  No migrations directory found"
    exit 0
fi

PENDING=0
APPLIED=0

for migration in "$MIGRATIONS_DIR"/*.sh; do
    [ -f "$migration" ] || continue

    ts=$(basename "$migration" | cut -d_ -f1)
    name=$(basename "$migration" .sh | cut -d_ -f2-)

    # Skip if already applied
    if grep -q "^$ts$" "$APPLIED_FILE" 2>/dev/null; then
        continue
    fi

    PENDING=$((PENDING + 1))

    if [ "$DRY_RUN" = true ]; then
        echo -e "  ${YELLOW}Would apply:${RESET} $ts - $name"
    else
        echo -e "  ${CYAN}Applying:${RESET} $ts - $name"

        # Run migration
        if bash "$migration"; then
            echo "$ts" >> "$APPLIED_FILE"
            APPLIED=$((APPLIED + 1))
            echo -e "  ${GREEN}✓${RESET} Applied: $name"
        else
            echo -e "  ${RED}✗${RESET} Failed: $name"
            echo -e "${RED}Migration failed. Stopping.${RESET}"
            exit 1
        fi
    fi
done

if [ "$PENDING" -eq 0 ]; then
    echo -e "  ${GREEN}No pending migrations${RESET}"
elif [ "$DRY_RUN" = true ]; then
    echo ""
    echo -e "${YELLOW}$PENDING migration(s) would be applied${RESET}"
    echo "Run without --dry-run to apply"
else
    echo ""
    echo -e "${GREEN}$APPLIED migration(s) applied${RESET}"
fi
