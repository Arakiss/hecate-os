# HecateOS Kernel Performance Tuning
# Optimized for 128GB RAM, NVMe storage, and high-throughput workloads

# =====================================
# Virtual Memory Tuning
# =====================================

# Reduce swappiness (we have 128GB RAM + ZRAM)
vm.swappiness = 10

# Increase dirty ratio for better write performance
vm.dirty_ratio = 40
vm.dirty_background_ratio = 10

# Time before dirty data is written to disk (centisecs)
vm.dirty_writeback_centisecs = 1500
vm.dirty_expire_centisecs = 3000

# Reduce cache pressure (we have plenty of RAM)
vm.vfs_cache_pressure = 50

# Increase max memory map areas for large applications
vm.max_map_count = 2147483642

# Enable transparent huge pages
vm.transparent_hugepage = always
vm.transparent_hugepage.enabled = always
vm.transparent_hugepage.defrag = madvise

# Increase shared memory limits
kernel.shmmax = 68719476736
kernel.shmall = 16777216
kernel.shmmni = 4096

# =====================================
# Network Performance Tuning
# =====================================

# Core network settings
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 65535
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.core.rmem_default = 33554432
net.core.wmem_default = 33554432
net.core.optmem_max = 40960

# TCP tuning
net.ipv4.tcp_rmem = 4096 87380 134217728
net.ipv4.tcp_wmem = 4096 65536 134217728
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_fin_timeout = 10
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 5
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fastopen = 3
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_congestion_control = bbr
net.core.default_qdisc = fq

# Enable TCP timestamps
net.ipv4.tcp_timestamps = 1

# Enable window scaling
net.ipv4.tcp_window_scaling = 1

# Increase TCP buffer limits
net.ipv4.tcp_mem = 786432 1048576 26777216
net.ipv4.udp_mem = 786432 1048576 26777216

# Connection tracking (for Docker/Kubernetes)
net.netfilter.nf_conntrack_max = 524288
net.nf_conntrack_max = 524288

# =====================================
# File System Tuning
# =====================================

# Increase file descriptor limits
fs.file-max = 2097152
fs.nr_open = 2097152

# Increase inotify limits for IDEs and file watchers
fs.inotify.max_user_watches = 524288
fs.inotify.max_user_instances = 8192
fs.inotify.max_queued_events = 32768

# AIO limits
fs.aio-max-nr = 1048576

# =====================================
# Kernel Tuning
# =====================================

# Increase PID limit
kernel.pid_max = 4194304

# Enable SysRq for debugging (can be disabled in production)
kernel.sysrq = 1

# Core dump settings
kernel.core_uses_pid = 1
kernel.core_pattern = /var/crash/core-%e-%s-%u-%g-%p-%t

# Increase message queue limits
kernel.msgmnb = 65536
kernel.msgmax = 65536
kernel.msgmni = 32768

# Disable kernel task scheduler autogroups for better CPU performance
kernel.sched_autogroup_enabled = 0

# Reduce kernel scheduling latency
kernel.sched_min_granularity_ns = 10000000
kernel.sched_wakeup_granularity_ns = 15000000
kernel.sched_migration_cost_ns = 5000000

# NUMA balancing
kernel.numa_balancing = 1

# =====================================
# Security (Performance over Security)
# =====================================

# Disable Source routing
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# Disable ICMP redirects
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0

# Enable IP forwarding for Docker
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1

# Disable IPv6 if not needed (uncomment to disable)
# net.ipv6.conf.all.disable_ipv6 = 1
# net.ipv6.conf.default.disable_ipv6 = 1

# =====================================
# NVMe Specific Optimizations
# =====================================

# Increase read-ahead for NVMe devices
# (Applied per-device via udev rules)

# =====================================
# GPU/CUDA Optimizations
# =====================================

# Increase memory limits for GPU operations
vm.max_map_count = 2147483642
vm.overcommit_memory = 1

# =====================================
# Debugging & Monitoring
# =====================================

# Enable more detailed kernel timing information
kernel.timer_migration = 0

# Performance events
kernel.perf_event_paranoid = -1
kernel.perf_event_max_contexts_per_stack = 8

# =====================================
# Power Management
# =====================================

# Disable laptop mode (we're on a workstation)
vm.laptop_mode = 0

# Keep memory pages longer before writing to swap
vm.watermark_scale_factor = 200