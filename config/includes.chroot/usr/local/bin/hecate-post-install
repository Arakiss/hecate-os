#!/bin/bash
#
# HecateOS Post-Installation Script
# Completes system setup after initial installation
#
set -e

# Colors
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
WHITE='\033[1;37m'
RESET='\033[0m'

# ASCII Art Logo
show_logo() {
    echo -e "${PURPLE}"
    cat << 'EOF'
    ╦ ╦┌─┐┌─┐┌─┐┌┬┐┌─┐╔═╗╔═╗
    ╠═╣├┤ │  ├─┤ │ ├┤ ║ ║╚═╗
    ╩ ╩└─┘└─┘┴ ┴ ┴ └─┘╚═╝╚═╝
    
    Post-Installation Setup
EOF
    echo -e "${RESET}"
}

# Check if running as root
check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}This script must be run as root${RESET}"
        echo "Usage: sudo $0"
        exit 1
    fi
}

# Progress indicator
progress() {
    echo -e "\n${CYAN}==>${RESET} $1"
}

# Success indicator
success() {
    echo -e "${GREEN}✓${RESET} $1"
}

# Warning indicator
warning() {
    echo -e "${YELLOW}⚠${RESET} $1"
}

# Error indicator
error() {
    echo -e "${RED}✗${RESET} $1"
}

# Main installation steps
main() {
    show_logo
    check_root
    
    echo -e "${WHITE}Starting HecateOS Post-Installation Setup...${RESET}"
    echo -e "${WHITE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}\n"
    
    # Step 1: Update system
    progress "Updating system packages..."
    apt update && apt full-upgrade -y
    success "System updated"
    
    # Step 2: Install mainline kernel tool
    progress "Installing mainline kernel manager..."
    if ! command -v mainline &> /dev/null; then
        add-apt-repository -y ppa:cappelikan/ppa
        apt update
        apt install -y mainline
        success "Mainline kernel manager installed"
    else
        success "Mainline already installed"
    fi
    
    # Step 3: Configure NVIDIA Container Toolkit
    progress "Configuring NVIDIA Container Toolkit..."
    if ! command -v nvidia-ctk &> /dev/null; then
        distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
        curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
        curl -s -L https://nvidia.github.io/libnvidia-container/$distribution/libnvidia-container.list | \
            sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
            tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
        apt update
        apt install -y nvidia-container-toolkit
        nvidia-ctk runtime configure --runtime=docker
        systemctl restart docker
        success "NVIDIA Container Toolkit configured"
    else
        success "NVIDIA Container Toolkit already configured"
    fi
    
    # Step 4: Verify NVIDIA driver
    progress "Verifying NVIDIA driver..."
    if nvidia-smi &> /dev/null; then
        GPU_INFO=$(nvidia-smi --query-gpu=name,memory.total,driver_version --format=csv,noheader)
        success "NVIDIA driver working: $GPU_INFO"
        
        # Apply GPU optimizations
        nvidia-smi -pm 1 &> /dev/null && success "Persistence mode enabled"
        nvidia-smi -pl 450 &> /dev/null && success "Power limit set to 450W" || warning "Could not set power limit"
    else
        error "NVIDIA driver not loaded. Please install manually or reboot."
    fi
    
    # Step 5: Verify ZRAM
    progress "Verifying ZRAM configuration..."
    if swapon --show | grep -q zram; then
        ZRAM_INFO=$(swapon --show | grep zram)
        success "ZRAM active: $ZRAM_INFO"
    else
        warning "ZRAM not active. Configuring..."
        systemctl enable --now zramswap
        success "ZRAM service enabled"
    fi
    
    # Step 6: Apply performance tuning
    progress "Applying performance optimizations..."
    
    # Set CPU governor
    for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
        echo "performance" > $cpu 2>/dev/null || true
    done
    success "CPU governor set to performance"
    
    # Apply tuned profile
    tuned-adm profile throughput-performance
    success "Tuned profile set to throughput-performance"
    
    # Apply sysctl settings
    sysctl -p /etc/sysctl.d/99-hecate-performance.conf
    success "Kernel parameters optimized"
    
    # Step 7: Configure development tools
    progress "Configuring development environment..."
    
    # Python setup
    if command -v python3 &> /dev/null; then
        pip3 install --upgrade pip setuptools wheel
        pip3 install virtualenv pipenv poetry
        success "Python development tools configured"
    fi
    
    # Node.js setup
    if command -v npm &> /dev/null; then
        npm install -g yarn pnpm @nestjs/cli @angular/cli create-react-app
        success "Node.js development tools configured"
    fi
    
    # Step 8: Detect Windows for dual-boot
    progress "Detecting Windows installation..."
    if command -v os-prober &> /dev/null; then
        WINDOWS_DETECTED=$(os-prober | grep -i windows || true)
        if [ ! -z "$WINDOWS_DETECTED" ]; then
            update-grub
            success "Windows detected and added to GRUB: $WINDOWS_DETECTED"
        else
            warning "No Windows installation detected"
        fi
    fi
    
    # Step 9: Create user directories
    progress "Creating user directories..."
    for user_home in /home/*; do
        if [ -d "$user_home" ]; then
            username=$(basename "$user_home")
            mkdir -p "$user_home"/{Documents,Downloads,Projects,Scripts,Workspace}
            chown -R "$username:$username" "$user_home"/{Documents,Downloads,Projects,Scripts,Workspace}
            success "Directories created for $username"
        fi
    done
    
    # Step 10: Install Oh My Zsh (optional)
    progress "Installing Oh My Zsh for enhanced terminal..."
    if [ ! -d "/home/$(logname)/.oh-my-zsh" ]; then
        sudo -u $(logname) sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
        success "Oh My Zsh installed"
    else
        success "Oh My Zsh already installed"
    fi
    
    # Step 11: System information
    echo -e "\n${WHITE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
    echo -e "${WHITE}System Information:${RESET}"
    echo -e "${WHITE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
    
    echo -e "Kernel: ${CYAN}$(uname -r)${RESET}"
    echo -e "CPU: ${CYAN}$(lscpu | grep "Model name" | cut -d: -f2 | xargs)${RESET}"
    echo -e "Memory: ${CYAN}$(free -h | grep Mem | awk '{print $2}')${RESET}"
    
    if nvidia-smi &> /dev/null; then
        echo -e "GPU: ${CYAN}$(nvidia-smi --query-gpu=name --format=csv,noheader)${RESET}"
        echo -e "NVIDIA Driver: ${CYAN}$(nvidia-smi --query-gpu=driver_version --format=csv,noheader)${RESET}"
    fi
    
    echo -e "\n${WHITE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
    echo -e "${GREEN}HecateOS Post-Installation Complete!${RESET}\n"
    
    echo -e "${WHITE}Next Steps:${RESET}"
    echo -e "1. Reboot the system: ${CYAN}sudo reboot${RESET}"
    echo -e "2. In BIOS, set Samsung 990 PRO as first boot device"
    echo -e "3. GRUB should show both HecateOS and Windows"
    echo -e "4. Verify NVIDIA: ${CYAN}nvidia-smi${RESET}"
    echo -e "5. Test Docker GPU: ${CYAN}docker run --rm --gpus all nvidia/cuda:12.6.0-base-ubuntu24.04 nvidia-smi${RESET}"
    echo -e "6. Check system info: ${CYAN}hecate-info --all${RESET}"
    echo ""
    echo -e "${PURPLE}Welcome to HecateOS - Unleash the beast within your machine!${RESET}"
}

# Run main function
main "$@"