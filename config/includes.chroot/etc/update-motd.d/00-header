#!/bin/bash

# HecateOS Dynamic MOTD Header
# Colors
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
WHITE='\033[1;37m'
RESET='\033[0m'

# Get system info
KERNEL=$(uname -r)
UPTIME=$(uptime -p | cut -d' ' -f2-)
CPU_MODEL=$(lscpu | grep "Model name" | cut -d: -f2 | xargs)
GPU_MODEL=$(nvidia-smi --query-gpu=name --format=csv,noheader 2>/dev/null || echo "No NVIDIA GPU detected")
RAM_TOTAL=$(free -h | grep Mem | awk '{print $2}')
RAM_USED=$(free -h | grep Mem | awk '{print $3}')
LOAD=$(cat /proc/loadavg | awk '{print $1, $2, $3}')

cat << EOF

${PURPLE}╦ ╦┌─┐┌─┐┌─┐┌┬┐┌─┐╔═╗╔═╗${RESET}     
${PURPLE}╠═╣├┤ │  ├─┤ │ ├┤ ║ ║╚═╗${RESET}  ${WHITE}High-Performance Linux Workstation${RESET}
${PURPLE}╩ ╩└─┘└─┘┴ ┴ ┴ └─┘╚═╝╚═╝${RESET}  ${CYAN}v24.04 LTS "Crossroads"${RESET}

${WHITE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}

  ${YELLOW}⚡ System Information${RESET}
  ├─ ${WHITE}Hostname:${RESET}    $(hostname)
  ├─ ${WHITE}Kernel:${RESET}      ${KERNEL}
  ├─ ${WHITE}Uptime:${RESET}      ${UPTIME}
  └─ ${WHITE}Load:${RESET}        ${LOAD}

  ${CYAN}󰍛 Hardware${RESET}
  ├─ ${WHITE}CPU:${RESET}         ${CPU_MODEL}
  ├─ ${WHITE}GPU:${RESET}         ${GPU_MODEL}
  └─ ${WHITE}Memory:${RESET}      ${RAM_USED} / ${RAM_TOTAL}

EOF

# Check for NVIDIA GPU and display stats if available
if command -v nvidia-smi &> /dev/null; then
    GPU_TEMP=$(nvidia-smi --query-gpu=temperature.gpu --format=csv,noheader 2>/dev/null)
    GPU_UTIL=$(nvidia-smi --query-gpu=utilization.gpu --format=csv,noheader 2>/dev/null)
    GPU_MEM=$(nvidia-smi --query-gpu=memory.used,memory.total --format=csv,noheader,nounits 2>/dev/null | awk -F, '{printf "%s / %s MB", $1, $2}')
    
    if [ ! -z "$GPU_TEMP" ]; then
        echo "  ${GREEN}󰢮 GPU Status${RESET}"
        echo "  ├─ ${WHITE}Temperature:${RESET} ${GPU_TEMP}°C"
        echo "  ├─ ${WHITE}Utilization:${RESET} ${GPU_UTIL}"
        echo "  └─ ${WHITE}Memory:${RESET}      ${GPU_MEM}"
        echo ""
    fi
fi

echo "${WHITE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
echo ""

# Performance mode reminder
if [ -f /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor ]; then
    GOVERNOR=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor)
    if [ "$GOVERNOR" = "performance" ]; then
        echo "  ${GREEN}✓${RESET} Performance mode active"
    else
        echo "  ${YELLOW}⚠${RESET}  CPU governor: $GOVERNOR (run 'sudo tuned-adm profile throughput-performance' for max performance)"
    fi
fi

echo ""